# Test suite for Climate Control System
test_suite:
  name: "Climate Control Test Suite"
  system_spec: "climate_control_spec.yaml"
  metadata:
    version: "1.0"
    author: "Test Team"
    stop_on_failure: false
    
  setup:
    - log: "Initializing climate control test environment"
    - inject:
        # Set initial conditions
        "Vehicle.Powertrain.ElectricMotor.Power": 0
        "Vehicle.Powertrain.TractionBattery.StateOfCharge.Current": 80.0
        "Vehicle.Exterior.AirTemperature": 25.0
        "Vehicle.Body.Windshield.Front.IsHeatingOn": false
    - wait: 0.5
    
  test_cases:
    - name: "Normal cooling operation"
      description: "Verify system enters cooling mode when cabin is too warm"
      requirements: ["REQ-CC-001"]
      steps:
        # Power on the system
        - inject:
            "Vehicle.Powertrain.ElectricMotor.Power": 15.0  # Engine running
            
        - expect_state:
            machine: "ClimateControl"
            state: "IDLE"
            timeout: 2
            
        # Set temperature conditions for cooling
        - inject:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 28.0
            "Vehicle.Cabin.Infotainment.HMI.TargetTemperature": 22.0
            
        - wait: 0.5
        
        # Verify cooling starts
        - expect_state:
            machine: "ClimateControl"
            state: "COOLING"
            timeout: 3
            
        - expect:
            "Vehicle.Cabin.HVAC.IsAirConditioningActive":
              value: true
              mode: "target"
              
        - expect:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.FanSpeed":
              value: "> 0"
              mode: "target"
              
        # Simulate temperature dropping
        - inject:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 22.3
            
        - wait: 0.5
        
        # Verify return to idle
        - expect_state:
            machine: "ClimateControl"
            state: "IDLE"
            timeout: 2
            
    - name: "Low battery prevents start"
      description: "Verify system enters error state when battery is too low"
      requirements: ["REQ-CC-004"]
      steps:
        # Set low battery condition
        - inject:
            "Vehicle.Powertrain.ElectricMotor.Power": 0  # Engine off
            "Vehicle.Powertrain.TractionBattery.StateOfCharge.Current": 15.0
            
        # Try to power on
        - log: "Attempting to start with low battery"
        
        - expect_state:
            machine: "ClimateControl"
            state: "ERROR"
            timeout: 2
            
        # Verify no actuators are active
        - expect:
            "Vehicle.Cabin.HVAC.IsAirConditioningActive":
              value: false
              mode: "target"
              
        - expect:
            "Vehicle.Cabin.HVAC.IsHeaterActive":
              value: false
              mode: "target"
              
    - name: "ECO mode activation"
      description: "Verify ECO mode activates at low battery"
      requirements: ["REQ-CC-003", "REQ-CC-006"]
      setup:
        # Start with system in IDLE
        - inject:
            "Vehicle.Powertrain.ElectricMotor.Power": 10.0
            "Vehicle.Powertrain.TractionBattery.StateOfCharge.Current": 50.0
        - wait: 1
        
      steps:
        # Reduce battery level
        - inject:
            "Vehicle.Powertrain.TractionBattery.StateOfCharge.Current": 25.0
            
        - wait: 0.5
        
        # Verify ECO mode
        - expect_state:
            machine: "ClimateControl"
            state: "ECO_MODE"
            timeout: 3
            
        # Verify fan speed limit
        - inject:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 30.0
            "Vehicle.Cabin.Infotainment.HMI.TargetTemperature": 22.0
            
        - wait: 1
        
        - expect:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.FanSpeed":
              value: "<= 3"
              mode: "target"
              
    - name: "Defrost priority"
      description: "Verify defrost mode takes priority over other modes"
      requirements: ["REQ-CC-005"]
      setup:
        - inject:
            "Vehicle.Powertrain.ElectricMotor.Power": 15.0
            "Vehicle.Powertrain.TractionBattery.StateOfCharge.Current": 70.0
        - wait: 1
        
      steps:
        # First enter cooling mode
        - inject:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 28.0
            "Vehicle.Cabin.Infotainment.HMI.TargetTemperature": 22.0
            
        - expect_state:
            machine: "ClimateControl"
            state: "COOLING"
            timeout: 2
            
        # Request defrost
        - inject:
            "Vehicle.Body.Windshield.Front.IsHeatingOn": true
            
        - wait: 0.5
        
        # Verify defrost mode
        - expect_state:
            machine: "ClimateControl"
            state: "DEFROST"
            timeout: 2
            
        - expect:
            "Vehicle.Cabin.HVAC.IsHeaterActive":
              value: true
              mode: "target"
              
        - expect:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.FanSpeed":
              value: ">= 4"
              mode: "target"
              
        - expect:
            "Vehicle.Cabin.HVAC.IsRecirculationActive":
              value: false
              mode: "target"
              
    - name: "Heating operation"
      description: "Verify heating activates when cabin is cold"
      requirements: ["REQ-CC-002"]
      steps:
        - inject:
            "Vehicle.Powertrain.ElectricMotor.Power": 15.0
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 18.0
            "Vehicle.Cabin.Infotainment.HMI.TargetTemperature": 24.0
            
        - expect_state:
            machine: "ClimateControl"
            state: "HEATING"
            timeout: 3
            
        - expect:
            "Vehicle.Cabin.HVAC.IsHeaterActive":
              value: true
              mode: "target"
              
        # Temperature reaches target
        - inject:
            "Vehicle.Cabin.HVAC.Station.Row1.Left.Temperature": 23.8
            
        - expect_state:
            machine: "ClimateControl" 
            state: "IDLE"
            timeout: 2
            
  teardown:
    - log: "Cleaning up test environment"
    - inject:
        "Vehicle.Powertrain.ElectricMotor.Power": 0